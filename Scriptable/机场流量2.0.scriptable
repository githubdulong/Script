/*
authorï¼šboruiqiao
telegramï¼šhttps://t.me/qiaoborui
*/
var url = ""//è®¢é˜…é“¾æ¥
var titles = "" //æœºåœºåç§°
var size = 12//æ˜¾ç¤ºå­—ä½“å¤§å°
var colors = []
var isdark=Device.isUsingDarkAppearance()
if(isdark){colors=["868f96","596164"];textcl=Color.white()}
// ä¸Šé¢ä¸¤ä¸ªä¸ºæš—é»‘æ¨¡å¼æ¸å˜
else{colors=["0EB6F7","fbc2eb"];textcl=Color.black()}  
// ä¸Šé¢ä¸ºæ­£å¸¸æ¨¡å¼æ¸å˜
function addTextToListWidget(text, listWidget) {
	let item = listWidget.addText(text)
	item.textColor = textcl
	item.textSize = size
}
var data = await getdata()
let widget = createWidget()
Script.setWidget(widget)
Script.complete()
async function getdata(){
  var req = new Request(url)
  req.method="GET"
  await req.load()
  const subkey = Object.keys(req.response.headers).filter(k => /SUBSCRIPTION-USERINFO/i.test(k))[0];
  const userinfo = req.response.headers[subkey];
  var resp = req.response.headers[subkey]
  const upload_k = Number(userinfo.match(/upload=(\d+)/)[1])/1048576;
  const download_k = Number(userinfo.match(/download=(\d+)/)[1])/1048576;
  const total_k = Number(userinfo.match(/total=(\d+)/)[1])/1048576;
  const expire_time = userinfo.match(/expire=(\d+)/)
  console.log(userinfo)
  let expires = "æ— ä¿¡æ¯"
  if (expire_time) {
  expires = formatTime(Number(expire_time[1] * 1000));
  }
  return [upload_k,download_k,total_k,expires]
  console.log(resp)
return resp
}
function createWidget(){
  let listWidget = new ListWidget()
  let backgroundColor = new LinearGradient()
  backgroundColor.colors = [new Color(colors[0]), new Color(colors[1])]
  backgroundColor.locations = [0.0, 1]
  listWidget.backgroundGradient = backgroundColor
  let emoji = listWidget.addText("ğŸ“Ÿ")
  emoji.textSize = 35
  let title = listWidget.addText(titles)
  title.applyHeadlineTextStyling()
  title.textColor = textcl
  var total = (data[2]/1024).toFixed(0)
  var remain = ((data[2]-data[0]-data[1])/1024).toFixed(2)
  var use = (total - remain).toFixed(2)
  var expires = data[3]
//   addTextToListWidget("\n",listWidget)
  addTextToListWidget(`å‰©ä½™å¤©æ•°ï¼š${expires}`,listWidget)
  addTextToListWidget(`æµé‡æ€»è®¡ï¼š${total}GB`,listWidget)
  addTextToListWidget(`è¿‡å»ä½¿ç”¨ï¼š${use}GB`,listWidget)
  addTextToListWidget(`å‰©ä½™å¯ç”¨ï¼š${remain}GB`,listWidget)
  listWidget.presentSmall()
	return listWidget
}
function formatTime(timestamp) {
  const dateStart = Date.parse(new Date());
  console.log(dateStart)
  console.log(timestamp)
  return Math.ceil((timestamp - dateStart) / (1000 * 60 * 60 * 24))+"å¤©"
}

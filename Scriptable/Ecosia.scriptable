// Scriptableä½¿ç”¨çš„å˜é‡;
// Ecosiaæ˜¯ä¸€ä¸ªæ€»éƒ¨ä½äºå¾·å›½æŸæ—çš„æœç´¢å¼•æ“ï¼Œå®ƒä»¬å°†è‡³å°‘80%çš„åˆ©æ¶¦æèµ ç»™éè¥åˆ©ç»„ç»‡ï¼Œç”¨äºç§æ¤æ ‘æœ¨ã€‚è¯¥ç»„ä»¶ç”¨äºæ˜¾ç¤ºè´¦æˆ·æ¤æ ‘;
// å¯æ­é…å¿«æ·æœç´¢è„šæœ¬è®¾ç½®ä¸ºé»˜è®¤æœç´¢å¼•æ“ä½“éªŒæ›´ä½³ https://raw.githubusercontent.com/githubdulong/Script/master/Surge/Q-Search_All_in_one.sgmodule;

// 1.1.4ç‰ˆæœ¬ "ä¿®æ”¹æ±‰åŒ–è‡ª https://www.scriptables.net";

// ç¬¬ä¸€æ­¥ï¼šå…ˆç™»é™† https://www.ecosia.org å†é€šè¿‡Safariå…±äº«èœå•ä½¿ç”¨å¿«æ·æ–¹å¼è·å–ä»¤ç‰Œï¼šhttps://www.icloud.com/shortcuts/8e3d009ee2a94c2d99d3cdb02f3e16d9;

// ç¬¬äºŒæ­¥ï¼šå°†è·å–åˆ°çš„ä»¤ç‰Œå¡«å…¥ Scriptable > Parameter;

let widgetInputRAW = args.widgetParameter;
let token;
if (widgetInputRAW !== null) {
  token = widgetInputRAW.toString().trim();
  if (/^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$/.test(token) === false) {	  
    throw new Errpr('ä»¤ç‰Œæ ¼å¼æ— æ•ˆ')
  }
} else {
  throw new Error('æ²¡æœ‰é€šè¿‡å°éƒ¨ä»¶å‚æ•°è®¾ç½®ä»¤ç‰Œï¼æ‚¨å¯ä»¥åœ¨æ­¤å¤„è¯·æ±‚ä»¤ç‰Œï¼šhttps://www.ecosia.org/account/login')
}
////////////////////////////////////////////////////////////////////////////////
let backColor; //å°ç»„ä»¶æ¸å˜ä¸ŠèƒŒæ™¯é¢œè‰²
let backColor2; //å°ç»„ä»¶æ¸å˜ä¸‹èƒŒæ™¯é¢œè‰²
let textColor; //å°ç»„ä»¶æ–‡æ–‡å­—é¢œè‰²

if (Device.isUsingDarkAppearance()) {
  backColor = '111111';
  backColor2 = '222222';
  textColor = 'EDEDED'; //if æš—é»‘æ¨¡å¼
} else {
  backColor = '229954';
  backColor2 = '52be80';
  textColor = 'EDEDED'; //else æ˜äº®æ¨¡å¼
}
////////////////////////////////////////////////////////////////////////////////
async function getTreeCounter(token) {
  try {
    const url = "https://api.ecosia.org/v1/accounts/v2/personal_counter?token=" + token
    let req = new Request(url)
    let res = await req.loadJSON()
    return parseInt(res.personal_counter)
  } catch (error) {
    throw new Error('An error occurred when loading data from the Ecosia API. Please check the entered token.')
  }
}

async function getLogo() {
  let fm = FileManager.local()
  const pathLogo = fm.joinPath(fm.temporaryDirectory(), 'ecosiaLogo')

  if (fm.fileExists(pathLogo)) {
    return fm.readImage(pathLogo)
  } else {
    try {
      let req = new Request('https://raw.githubusercontent.com/ThisIsBenny/iOS-Widgets/main/Ecosia/logo.png') //logo
      let logo = await req.loadImage()
      fm.writeImage(pathLogo, logo)
      return logo
    } catch (e) {
      console.error(e)
      return null
    }
  }
}
console.log('Load Tree Counter')
let treeCounter = await getTreeCounter(token);
console.log('Tree Counter loaded')
console.log(treeCounter)
console.log('Load Logo')
let ecosiaLogo = await getLogo()
console.log('Logo loaded')
// Create Widget
let widget = new ListWidget();

const gradient = new LinearGradient()
gradient.locations = [0, 1]
gradient.colors = [
  new Color(backColor),
  new Color(backColor2)
]
widget.backgroundGradient = gradient

widget.url = 'https://ecosia.org/'

widget.setPadding(10, 10, 10, 10)

if (ecosiaLogo !== null) {
  let titleLogo = widget.addImage(ecosiaLogo)
  titleLogo.imageSize = new Size(50, 50)
  titleLogo.rightAlignImage()
  if (config.widgetFamily === 'large') {
    widget.addSpacer()
  } else {
    widget.addSpacer(5)
  }
} else {
  let title = widget.addText("Ecosia")
  title.font = Font.mediumSystemFont(12)
  title.textColor = new Color(textColor)
  widget.addSpacer()
}

let counterText = widget.addText(`${treeCounter.toLocaleString(Device.locale().replace('_', '-'))} ğŸŒ²`) //ğŸŒ³ğŸŒ´
counterText.font = Font.regularSystemFont(36)
counterText.minimumScaleFactor = 0.7;
counterText.lineLimit = 1
counterText.centerAlignText()
counterText.textColor = new Color(textColor)

widget.addSpacer()

if (!config.runsInWidget) {
  await widget.presentSmall()
} else {
//   Tell the system to show the widget.
  Script.setWidget(widget)
  Script.complete()
}
